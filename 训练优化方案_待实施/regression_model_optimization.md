# 回归模型优化方案文档

## 一、背景说明
当前模型用于预测蛋白质-小分子之间的结合能力，任务为回归问题，目标变量已进行 log 变换，训练过程表现稳健，但观察到训练集与验证集 RMSE 存在一定差距，可能出现预测“平均化”现象，并通过实验证明了对于部分极限值确实存在平均化现象。为进一步提升模型的泛化能力和精度，制定如下优化方案。

---

## 二、优化目标
- 缓解预测平均化问题
- 提升极端值（高/低结合能力）预测能力
- 增强模型对不确定性的表达
- 使用多指标更全面评估模型性能

---

## 三、优化方案

### 3.1 更换/增强损失函数
- ✅ **Huber Loss**：鲁棒性强，对中值段收敛快，对极值误差不敏感。
- ✅ **Log-Cosh Loss**：平滑、对大误差不敏感，减轻极端值影响。
- ✅ **Negative Log Likelihood Loss (NLLLoss)**：结合高斯输出，实现预测区间估计（见 3.3）。

### 3.2 样本加权
- 对训练集中落在目标值分布两端的样本加权（例如远离均值者权重更高），避免模型偏向分布主区间。

```python
weights = (targets - targets.mean()).abs()
loss = (weights * loss_fn(preds, targets)).mean()
```

---

### 3.3 输出预测区间（模型不确定性）
- 修改模型结构，使其输出两个值：预测均值 `\mu` 和标准差 `\sigma`。
- 使用 **Gaussian NLLLoss** 实现联合建模：

```python
def gaussian_nll(mu, sigma, target):
    loss = torch.log(sigma + 1e-6) + 0.5 * ((target - mu)**2 / (sigma**2 + 1e-6))
    return torch.mean(loss)
```

- 模型最后一层输出 `x -> [\mu, \log(\sigma)]`，确保 `\sigma > 0`。

---

### 3.4 多指标联合评估
- 除 RMSE 外，加入以下指标：
  - **R² 分数**：衡量解释方差能力
  - **MAE（平均绝对误差）**：反映实际偏离程度
  - **95% 置信区间覆盖率（PICP）**：用于评估预测区间的可信度
  - **CRPS**（连续秩概率评分）：评估概率预测质量

---

### 3.5 数据增强与验证集构造
- 使用分层采样（基于目标值分布）划分训练/验证集，确保各区间样本分布一致；
- 可进行 SMOGN 或类似回归过采样增强低频样本；

---

### 3.6 可视化分析建议
- 绘制预测值 vs 实际值散点图，检查是否“集中在中间”；
- 绘制预测值分布 vs 真实分布的 KDE 曲线；
- 分析每个目标值区间段（如：低/中/高）上的 RMSE 和 MAE；

---

> 文档版本：v1.0  
> 更新时间：2025-03-26
